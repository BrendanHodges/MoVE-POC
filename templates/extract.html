<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MoVE | Data Extraction</title>

  <link rel="stylesheet" href="/static/css/site.css" />

  <!-- Tabulator CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/css/tabulator.min.css">
  <!-- Tabulator JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>

  <style>
    :root{
      --card-bg: #ffffff;
      --page-bg: #ffffff;
      --card-radius: 12px;
      --card-shadow: 0 2px 6px rgba(0,0,0,0.06);
      --section-gap: 16px;
    }

    body{
      margin: 0;
      background: var(--page-bg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #extractor-layout{
      display: grid !important;
      grid-template-columns: 2.5fr 1fr;
      grid-template-rows: 1fr auto;  
      gap: 5px;
      align-items: stretch;         
      min-height: calc(100vh - 140px); 
    }

    #extractor-filters{
      border-radius: var(--card-radius);
      background: var(--card-bg);
      border: 1px solid var(--border);
      box-shadow: var(--card-shadow);
      padding: 14px;
      overflow-y: auto;
    }

    #extractor-preview{
      border-radius: var(--card-radius);
      background: var(--card-bg);
      border: 1px solid var(--border);
      box-shadow: var(--card-shadow);
      padding: 14px;
      overflow-y: auto;
      height: 100%;
      max-height: 70vh;
  
    }

    #preview-panel{
      grid-column: 1 / -1;
      border-radius: var(--card-radius);
      background: var(--card-bg);
      border: 1px solid var(--border);
      box-shadow: var(--card-shadow);
      padding: 18px 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 520px;
      height: 100%;
      max-height: none;
    }

    /* Step tabs as segmented control */
    .step-tabs{
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 2px;
      background: #f7f7f7;
      margin-bottom: 16px;
      gap: 2px;
    }

    .step-tab{
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
      background: transparent;
      transition: background 0.15s, color 0.15s;
      white-space: nowrap;
    }

    .step-tab.active{
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .step-page{
      display: none;
    }

    .step-page.active{
      display: block;
    }

    /* Fieldsets as modern cards */
    #extractor-filters fieldset{
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fafafa;
      padding: 12px 12px 10px;
      margin: 0 0 12px 0;
    }

    #extractor-filters legend{
      padding: 0 6px;
      font-size: 0.9rem;
      color: var(--muted);
      font-weight: 500;
    }

    /* Inputs */
    #extractor-filters input[type="text"],
    #extractor-filters select{
      width: 100%;
      padding: 8px 9px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 0.92rem;
      box-sizing: border-box;
      background: #ffffff;
    }

    #extractor-filters label{
      font-size: 0.9rem;
    }

    /* Actions bar */
    #actions-bar{
      border-top: 1px solid var(--border);
      margin-top: 18px;
      padding-top: 14px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }

    .tab-button{
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f5f5f5;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.15s, transform 0.05s;
    }

    .tab-button:enabled:hover{
      background: #e9f0ff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .tab-button:active{
      transform: translateY(1px);
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }

    #previewBtn,
    #exportCsvBtn,
    #exportJsonBtn{
      background: #e3edff;
      border-color: #c4d7ff;
    }

    #previewBtn:hover,
    #exportCsvBtn:hover,
    #exportJsonBtn:hover{
      background: #d6e4ff;
    }

    /* Selected variables card */
    #selected-variables{
      border-radius: 8px;
      border: 1px dashed var(--border);
      background: #fafafa;
    }

    /* Preview table container */
    #preview-table{
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow-x: auto;
      min-height: 220px;
      background: #ffffff;
    }

    #preview-grid .tabulator{
      min-width: 1100px;
    }

    /* Preview header bar */
    #preview-panel-header{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #f7f7f7;
      border: 1px solid var(--border);
    }

    @media (max-width: 980px){
      #extractor-layout{
        grid-template-columns: 1fr;
      }
      #extractor-preview{
        max-height: none;
      }
    }

    /* Full table modal */
    #fullTableModal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.45);
      z-index:9999;
      padding:24px;
    }

    #fullTableModal > div{
      background: var(--card-bg);
      border:1px solid var(--border);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
    }
    
    /*Variable button Tabs*/
    .var-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
    }
    
    .var-tab {
      padding: 6px 12px;
      border: 1px solid #ccc;
      background: #f7f7f7;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .var-tab.active {
      background: #2c7be5;
      color: white;
      border-color: #2c7be5;
    }

    .var-panel {
      display: none;
    }

    .var-panel.active {
      display: block;
    }

  </style>
</head>

<body>
  <main class="container" style="padding-top: 22px; padding-bottom: 26px;">
    <div class="dashboard-header" style="margin-bottom: 18px;">
      <h2 style="margin: 0;">Data Extraction</h2>
      <p style="margin: 6px 0 0 0; color: var(--muted); font-size: 0.95rem;">
        Configure your geography and variables, preview a sample of the data, then export your extraction.
      </p>
    </div>

    <div id="extractor-layout">
      <!-- LEFT: Control Panel -->
      <aside id="extractor-filters">

        <div class="step-tabs" aria-label="Steps">
          <div class="step-tab active" data-step-tab="1">1) Geography</div>
          <div class="step-tab" data-step-tab="2">2) Variables</div>
        </div>

        <!-- STEP 1 -->
        <section class="step-page active" data-step="1">
          <h3 style="margin: 0 0 10px 0; font-size: 1.05rem;">Geography</h3>

          <div style="margin-bottom: 14px;">
            <div style="display:flex; align-items:center; gap:6px; font-size:0.9rem; margin-bottom:6px; color:var(--muted); font-weight:500;">
              Export level
              <button type="button" class="info-btn" data-info="export-level">?</button>
            </div>

            <label style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
              <input type="radio" name="geo_level" value="state" checked />
              Export entire state
            </label>
            <label style="display:flex; gap:8px; align-items:center;">
              <input type="radio" name="geo_level" value="county" />
              Export single county
            </label>
          </div>

          <div style="margin-bottom: 12px;">
            <label for="stateInput" style="display:block; font-size:0.9rem; margin-bottom:4px; font-weight:500;">
              State (name or abbreviation)
              <button type="button" class="info-btn" data-info="multi-export">?</button>
            </label>
            <input id="stateInput" type="text" placeholder="e.g. Maryland or MD" />
          </div>

          <div style="margin-bottom: 10px;">
            <label for="countyInput" style="display:block; font-size:0.9rem; margin-bottom:4px; font-weight:500;">
              County ID
            </label>
            <input id="countyInput" type="text" placeholder="e.g. 24005" disabled />
          </div>

          <div style="font-size:0.85rem; color:var(--muted); margin-bottom:14px;">
            Use county ID only when exporting a single county.
            <a
              href="https://transition.fcc.gov/oet/info/maps/census/fips/fips.txt"
              target="_blank"
              rel="noopener noreferrer"
            >
              U.S FIPs codes
            </a>
          </div>

          <div style="display:flex; justify-content:flex-end;">
            <button type="button" class="tab-button" id="goStep2Btn">Next</button>
          </div>
        </section>

        <!-- STEP 2 -->
        <section class="step-page" data-step="2">
          <h3 style="margin: 0 0 10px 0; font-size:1.05rem;">MoVE Score & Variables</h3>

          <div style="margin-bottom: 12px; display:flex; align-items:center; gap:6px;">
            <label style="display:flex; gap:8px; align-items:center; font-size:0.9rem;">
              <input type="checkbox" id="includeMoveScore" checked />
              Include MoVE score in extraction
            </label>
            <button type="button" class="info-btn" data-info="move-score">?</button>
          </div>

          <hr style="border:none; border-top:1px solid var(--border); margin:14px 0;">

          <h3 style="margin: 0 0 10px 0; font-size:1rem;">Variables</h3>

          <div class="var-tabs">
            <button class="var-tab active" data-target="county">County</button>
            <button class="var-tab" data-target="state">State</button>
            <button class="var-tab" data-target="census">Census</button>
          </div>

          <div class="var-panels">
            <fieldset data-vartype="county" class="var-panel active">
              <legend style="display:flex; align-items:center; gap:6px;">
                MoVE County Level Variables
                <button type="button" class="info-btn" data-info="county-vars">?</button>
              </legend>

              <label for="CountyVar" style="display:block; font-size:0.9rem; margin-bottom:4px;">
                Select variable
              </label>
              <select id="CountyVar" class="county-dropdown">
                <option value="">Choose a variable...</option>
                <option value="v1_example_1">Example V1 - Option 1</option>
                <option value="v1_example_2">Example V1 - Option 2</option>
              </select>

              <button type="button" class="tab-button add-var-btn" style="margin-top:10px;">
                Add Variable
              </button>
            </fieldset>

            <fieldset data-vartype="state" class="var-panel">
              <legend style="display:flex; align-items:center; gap:6px;">
                MoVE State Level Variables
                <button type="button" class="info-btn" data-info="state-vars">?</button>
              </legend>

              <label for="StateVar" style="display:block; font-size:0.9rem; margin-bottom:4px;">
                Select variable
              </label>
              <select id="StateVar" class="county-dropdown">
                <option value="">Choose a variable...</option>
                <option value="v2_example_1">Example V2 - Option 1</option>
                <option value="v2_example_2">Example V2 - Option 2</option>
              </select>

              <button type="button" class="tab-button add-var-btn" style="margin-top:10px;">
                Add Variable
              </button>
            </fieldset>

            <fieldset data-vartype="census" class="var-panel" style="margin-bottom:4px;">
              <legend style="display:flex; align-items:center; gap:6px;">
                U.S. Census Variables
                <button type="button" class="info-btn" data-info="census-vars">?</button>
              </legend>

              <label for="CensusVar" style="display:block; font-size:0.9rem; margin-bottom:4px;">
                Select variable
              </label>
              <select id="CensusVar" class="county-dropdown">
                <option value="">Choose a variable...</option>
                <option value="v3_example_1">Example V3 - Option 1</option>
                <option value="v3_example_2">Example V3 - Option 2</option>
              </select>

              <button type="button" class="tab-button add-var-btn" style="margin-top:10px;">
                Add Variable
              </button>
            </fieldset>
          </div>

          <div style="margin-top:10px;">
            <button type="button" class="tab-button" id="backStep1Btn">Back</button>
          </div>
        </section>

        <!-- Actions bar -->
        <div id="actions-bar">
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button type="button" class="tab-button" id="previewBtn">Preview</button>
            <button type="button" class="tab-button" id="clearBtn">Clear</button>
            <button type="button" class="tab-button" id="showFullBtn" disabled>Show Full Table</button>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button type="button" class="tab-button" id="exportCsvBtn">Export CSV</button>
            <button type="button" class="tab-button" id="exportJsonBtn">Export JSON</button>
          </div>
        </div>

        <p style="margin-top:10px; font-size:0.85rem; color:var(--muted);">
          Preview generates a sample table so you can confirm selections before exporting.
        </p>
      </aside>

      <div id="infoPopup" hidden>
        <div id="infoPopupContent"></div>
        <button id="closeInfoPopup">Close</button>
      </div>


      <!-- RIGHT: Selected variables summary -->
      <section id="extractor-preview">
        <div style="display: flex; align-items: baseline; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
          <h3 style="margin: 0; font-size: 1.05rem;">Selected Variables</h3>
          <div style="color: var(--muted); font-size: 0.9rem;">
            <span id="selected-count">0</span> selected
          </div>
        </div>

        <div id="selected-variables"
             style="margin-top: 12px; padding: 12px; min-height: 52px;">
          <span style="color: var(--muted); font-size: 0.9rem;">
            No variables selected yet. Use the “Add Variable” buttons on the left.
          </span>
        </div>

        <div id="extractor-messages" style="margin-top: 10px; color: var(--muted); font-size: 0.9rem;"></div>
      </section>

      <!-- BOTTOM: Preview Table -->
      <section id="preview-panel">
        <div id="preview-panel-header">
          <h3 style="margin: 0; font-size: 1.05rem;">Preview Table</h3>
          <div style="color: var(--muted); font-size: 0.9rem;">
            Showing up to <span id="preview-limit">30</span> rows and 6 columns from your extraction
          </div>
        </div>

        <p style="margin: 6px 0 6px 0; color: var(--muted); font-size: 0.9rem;">
          Preview is for confirmation only. Exports may include more rows depending on your selection.
        </p>

        <div id="preview-table">
          <div id="preview-placeholder">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.92rem;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Status</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding: 8px; color: var(--muted);">
                    Click “Preview” to load sample rows based on your selections.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div id="preview-grid"></div>
        </div>
      </section>
    </div>
  </main>

  <script src="/static/js/extract.js"></script>

  <!-- Step switching only -->
  <script>
    const tabs = Array.from(document.querySelectorAll(".step-tab"));
    const pages = Array.from(document.querySelectorAll(".step-page"));

    function setStep(n){
      pages.forEach(p => p.classList.toggle("active", Number(p.dataset.step) === n));
      tabs.forEach(t => t.classList.toggle("active", Number(t.dataset.stepTab) === n));
    }

    tabs.forEach(t => t.addEventListener("click", () => setStep(Number(t.dataset.stepTab))));
    document.getElementById("goStep2Btn")?.addEventListener("click", () => setStep(2));
    document.getElementById("backStep1Btn")?.addEventListener("click", () => setStep(1));

    setStep(1);
  </script>

  <!-- Full table modal -->
  <div id="fullTableModal">
    <div style="width:min(1200px, 96vw); height:min(720px, 92vh);
                margin:0 auto; padding:16px; display:flex; flex-direction:column;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div style="font-size:1rem; font-weight:500;">Full Table</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button type="button" class="tab-button" id="downloadFullCsvBtn">Download CSV</button>
          <button type="button" class="tab-button" id="closeFullBtn">Close</button>
        </div>
      </div>

      <hr style="border:none; border-top:1px solid var(--border); margin:10px 0;">
      <div id="full-grid" style="flex:1; min-height:0;"></div>
    </div>
  </div>
</body>
</html>
